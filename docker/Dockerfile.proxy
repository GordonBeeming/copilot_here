# Build stage - use Alpine for smaller musl-based build
FROM rust:1.83-alpine AS builder

WORKDIR /build

# Install build dependencies for musl
RUN apk add --no-cache musl-dev openssl-dev openssl-libs-static pkgconfig

# Copy dependency files first for better caching
COPY proxy/Cargo.toml Cargo.toml
COPY proxy/Cargo.lock Cargo.lock

# Create dummy src to build dependencies (for caching)
RUN mkdir src && echo "fn main() {}" > src/main.rs
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/build/target \
    OPENSSL_STATIC=1 cargo build --release

# Copy actual source
COPY proxy/src src

# Touch main.rs to ensure rebuild of our code (not deps)
RUN touch src/main.rs

# Build release binary (statically linked with musl)
RUN --mount=type=cache,target=/usr/local/cargo/registry \
    --mount=type=cache,target=/build/target \
    OPENSSL_STATIC=1 cargo build --release && \
    cp /build/target/release/secure-proxy /build/secure-proxy

# Runtime stage - minimal Alpine
FROM alpine:3.21

# Install only essential runtime dependencies
# curl is needed for healthcheck
RUN apk add --no-cache ca-certificates su-exec curl

# Create proxy user
RUN addgroup -S proxy-user && adduser -S -G proxy-user -h /app proxy-user

# Copy binary from builder
COPY --from=builder /build/secure-proxy /app/secure-proxy

# Create directories
RUN mkdir -p /config /logs /ca && \
    chown -R proxy-user:proxy-user /app /config /logs /ca

# Copy entrypoint
COPY proxy-entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 58080

ENTRYPOINT ["/entrypoint.sh"]
