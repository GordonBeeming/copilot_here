# Build on top of the .NET image to add Rust capabilities
# This is the largest compound variant: .NET 8/9/10 + Rust
ARG DOTNET_IMAGE_TAG=dotnet
FROM ghcr.io/gordonbeeming/copilot_here:${DOTNET_IMAGE_TAG}

# Switch to root to install packages
USER root

# Install Rust dependencies
RUN apt-get update && apt-get install -y \
  build-essential \
  pkg-config \
  libssl-dev \
  && rm -rf /var/lib/apt/lists/*

# Install Rust toolchain to system-wide location
ENV RUSTUP_HOME=/usr/local/rustup
ENV CARGO_HOME=/usr/local/cargo
ENV PATH="/usr/local/cargo/bin:${PATH}"

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable

# Make cargo registry writable by all users (for downloading crates)
RUN chmod -R a+rwX /usr/local/cargo

# Verify installations
RUN dotnet --list-sdks && rustc --version && cargo --version

# The entrypoint and CMD remain the same as the base image
# They are inherited automatically
