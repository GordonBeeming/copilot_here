# Build on top of the base image to add Playwright capabilities
# ARG will be provided by the build process with the commit hash
ARG BASE_IMAGE_TAG
ARG PLAYWRIGHT_VERSION=latest
FROM ghcr.io/gordonbeeming/copilot_here:${BASE_IMAGE_TAG}

# Switch to root to install packages
USER root

# Install Playwright dependencies and Chromium
# Using Playwright's system dependencies approach
RUN apt-get update && apt-get install -y \
  # Playwright system dependencies for Chromium
  libnss3 \
  libnspr4 \
  libatk1.0-0 \
  libatk-bridge2.0-0 \
  libcups2 \
  libdrm2 \
  libdbus-1-3 \
  libxkbcommon0 \
  libxcomposite1 \
  libxdamage1 \
  libxfixes3 \
  libxrandr2 \
  libgbm1 \
  libpango-1.0-0 \
  libcairo2 \
  libasound2 \
  libatspi2.0-0 \
  libxshmfence1 \
  && rm -rf /var/lib/apt/lists/*

# Install Playwright globally via npm
RUN npm install -g playwright@${PLAYWRIGHT_VERSION}

# Set NODE_PATH so Node.js can find globally installed packages
ENV NODE_PATH=/usr/local/lib/node_modules

# Install all browsers (Chromium, Firefox, WebKit) in a system-wide location
# This avoids UID mismatch issues when container runs with different user IDs
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
RUN npx playwright install --with-deps

# Make playwright browsers directory world-writable so any UID can access/update them
RUN chmod -R 777 /ms-playwright

# The entrypoint and CMD remain the same as the base image
# They are inherited automatically
