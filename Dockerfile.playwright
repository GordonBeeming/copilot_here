# Build on top of the .NET image to add Playwright capabilities
# ARG will be provided by the build process with the commit hash
ARG DOTNET_IMAGE_TAG
FROM ghcr.io/gordonbeeming/copilot_here:${DOTNET_IMAGE_TAG}

# Switch to root to install packages
USER root

# Install Playwright dependencies and Chromium
# Using Playwright's system dependencies approach
RUN apt-get update && apt-get install -y \
  # Playwright system dependencies for Chromium
  libnss3 \
  libnspr4 \
  libatk1.0-0 \
  libatk-bridge2.0-0 \
  libcups2 \
  libdrm2 \
  libdbus-1-3 \
  libxkbcommon0 \
  libxcomposite1 \
  libxdamage1 \
  libxfixes3 \
  libxrandr2 \
  libgbm1 \
  libpango-1.0-0 \
  libcairo2 \
  libasound2 \
  libatspi2.0-0 \
  libxshmfence1 \
  && rm -rf /var/lib/apt/lists/*

# Install Playwright globally via npm
RUN npm install -g playwright@latest

# Create appuser for build-time operations if it doesn't exist
# The entrypoint will handle proper UID/GID mapping at runtime
RUN groupadd --gid 1000 appuser_group 2>/dev/null || true && \
    useradd --uid 1000 --gid 1000 --shell /bin/bash --create-home appuser 2>/dev/null || true

# Create the .copilot cache directory for appuser
RUN mkdir -p /home/appuser/.cache/ms-playwright && \
    chown -R 1000:1000 /home/appuser

# Switch to appuser before installing browsers so they're in the right cache location
USER appuser

# Install Chromium browser for Playwright as appuser
RUN npx playwright install chromium --with-deps

# The entrypoint and CMD remain the same as the base image
# They are inherited automatically
