# GitHub Actions workflow for running integration tests
name: Integration Tests

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
  workflow_call:  # Allow this workflow to be called by other workflows

permissions:
  contents: read

jobs:
  test-bash-zsh:
    name: Test Bash/Zsh on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install PowerShell (for cross-platform testing)
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            # Install PowerShell on Ubuntu
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https software-properties-common
            wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
            sudo dpkg -i packages-microsoft-prod.deb
            sudo apt-get update
            sudo apt-get install -y powershell
          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            # Install PowerShell on macOS
            brew install --cask powershell
          fi
      
      - name: Make test scripts executable
        run: chmod +x tests/run_all_tests.sh tests/integration/*.sh
        
      - name: Run all integration tests
        run: ./tests/run_all_tests.sh

  test-windows:
    name: Test PowerShell on Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run PowerShell integration tests
        shell: pwsh
        run: |
          pwsh tests/integration/test_powershell.ps1
          
      - name: Run PowerShell basic tests
        shell: pwsh
        run: |
          pwsh tests/integration/test_powershell_basic.ps1

  test-summary:
    name: All Tests Summary
    needs: [test-bash-zsh, test-windows]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-bash-zsh.result }}" != "success" ] || [ "${{ needs.test-windows.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed!"
          fi
