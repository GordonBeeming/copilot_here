# This workflow builds and publishes Docker images and native CLI binaries.
# Tests run first on all triggers. Publishing only happens on main branch.
name: Build and Publish

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    # Runs nightly at 3:15 AM UTC to check for package updates.
    - cron: "15 3 * * *"
  workflow_dispatch: # Allows the workflow to be run manually from the Actions tab

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

# Sets the minimum required permissions for the entire workflow for security.
permissions:
  contents: write
  packages: write

jobs:
  # Run CLI tests on all platforms
  test-cli:
    name: Test CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, macos-15-intel, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          global-json-file: global.json

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Test
        run: dotnet test --no-build --verbosity normal

  # CLI integration tests on all platforms
  test-cli-integration:
    name: Integration Tests (${{ matrix.os }})
    needs: [test-cli]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, macos-15-intel, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          global-json-file: global.json

      - name: Make test script executable (Unix)
        if: runner.os != 'Windows'
        run: chmod +x tests/integration/test_cli.sh

      - name: Run CLI integration tests (Unix)
        if: runner.os != 'Windows'
        run: ./tests/integration/test_cli.sh

      - name: Run CLI integration tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./tests/integration/test_cli.ps1

  # Test shell function scripts can be sourced and call the native binary
  test-shell-functions:
    name: Shell Functions (${{ matrix.os }})
    needs: [test-cli]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, macos-latest, macos-15-intel, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          global-json-file: global.json

      - name: Build CLI binary
        run: dotnet publish app/CopilotHere.csproj -c Release -o publish/shell-test --nologo

      - name: Test Bash script syntax
        if: runner.os != 'Windows'
        run: bash -n copilot_here.sh

      - name: Test Bash source and copilot_here --help
        if: runner.os != 'Windows'
        shell: bash
        run: |
          export COPILOT_HERE_BIN="$PWD/publish/shell-test/copilot_here"
          chmod +x "$COPILOT_HERE_BIN"
          source ./copilot_here.sh
          # Run --help and verify output contains expected text
          OUTPUT=$(copilot_here --help 2>&1)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "GitHub Copilot CLI"

      - name: Test Bash copilot_here --version
        if: runner.os != 'Windows'
        shell: bash
        run: |
          export COPILOT_HERE_BIN="$PWD/publish/shell-test/copilot_here"
          source ./copilot_here.sh
          OUTPUT=$(copilot_here --version 2>&1)
          echo "$OUTPUT"
          # Verify version format YYYY.MM.DD
          echo "$OUTPUT" | grep -qE "^[0-9]{4}\.[0-9]{2}\.[0-9]{2}"

      - name: Test Zsh source and copilot_here --help
        if: runner.os == 'macOS'
        shell: zsh {0}
        run: |
          export COPILOT_HERE_BIN="$PWD/publish/shell-test/copilot_here"
          source ./copilot_here.sh
          OUTPUT=$(copilot_here --help 2>&1)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "GitHub Copilot CLI"

      - name: Test PowerShell script syntax
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile("$PWD/copilot_here.ps1", [ref]$null, [ref]$errors)
          if ($errors.Count -gt 0) {
            $errors | ForEach-Object { Write-Error $_.Message }
            exit 1
          }
          Write-Host "✓ PowerShell syntax is valid"

      - name: Test PowerShell source and Copilot-Here --help
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:COPILOT_HERE_BIN = "$PWD\publish\shell-test\copilot_here.exe"
          . .\copilot_here.ps1
          $output = & $env:COPILOT_HERE_BIN --help 2>&1 | Out-String
          Write-Host $output
          if ($output -notmatch "GitHub Copilot CLI") {
            Write-Error "Expected 'GitHub Copilot CLI' in output"
            exit 1
          }

      - name: Test PowerShell copilot_here --version
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:COPILOT_HERE_BIN = "$PWD\publish\shell-test\copilot_here.exe"
          . .\copilot_here.ps1
          $output = & $env:COPILOT_HERE_BIN --version 2>&1 | Out-String
          Write-Host $output
          if ($output -notmatch "^\d{4}\.\d{2}\.\d{2}") {
            Write-Error "Expected version format YYYY.MM.DD"
            exit 1
          }

  # Airlock tests - Linux only (Docker with Linux containers required)
  test-airlock:
    name: Test Airlock
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          global-json-file: global.json

      - name: Build images locally
        run: |
          chmod +x ./dev-build.sh
          ./dev-build.sh

      - name: Make test script executable
        run: chmod +x tests/integration/test_airlock.sh

      - name: Run airlock integration tests
        run: ./tests/integration/test_airlock.sh --use-local

  # Build proxy Rust binary natively on each architecture (much faster than QEMU/Docker)
  build-proxy-binary:
    name: Build Proxy Binary (${{ matrix.arch }})
    needs: [test-cli-integration, test-shell-functions, test-airlock]
    runs-on: ${{ matrix.runner }}
    if: github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            target: x86_64-unknown-linux-musl
          - arch: arm64
            runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-musl
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable

      - name: Install musl tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools musl-dev

      - name: Add musl target
        run: rustup target add ${{ matrix.target }}

      - name: Build proxy binary
        working-directory: proxy
        run: |
          cargo build --release --target ${{ matrix.target }}
          cp target/${{ matrix.target }}/release/secure-proxy ../secure-proxy-${{ matrix.arch }}

      - name: Upload proxy binary
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: proxy-binary-${{ matrix.arch }}
          path: secure-proxy-${{ matrix.arch }}
          if-no-files-found: error

  # Build proxy Docker image using pre-built binaries
  build-proxy:
    name: Build Proxy Image
    needs: [build-proxy-binary]
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set lowercase repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Download proxy binaries
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          pattern: proxy-binary-*
          path: proxy-binaries
          merge-multiple: true

      - name: Prepare binaries for Docker
        run: |
          mv proxy-binaries/secure-proxy-amd64 proxy-amd64
          mv proxy-binaries/secure-proxy-arm64 proxy-arm64
          chmod +x proxy-amd64 proxy-arm64
          ls -la proxy-*

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to the Container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push proxy image (amd64)
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          file: ./docker/Dockerfile.proxy-runtime
          platforms: linux/amd64
          push: true
          provenance: false
          sbom: false
          tags: ghcr.io/${{ steps.repo.outputs.name }}:proxy-amd64
          labels: project=copilot_here

      - name: Build and push proxy image (arm64)
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          file: ./docker/Dockerfile.proxy-runtime
          platforms: linux/arm64
          push: true
          provenance: false
          sbom: false
          tags: ghcr.io/${{ steps.repo.outputs.name }}:proxy-arm64
          labels: project=copilot_here

      - name: Create and push multi-arch manifest
        run: |
          docker manifest create ghcr.io/${{ steps.repo.outputs.name }}:proxy \
            ghcr.io/${{ steps.repo.outputs.name }}:proxy-amd64 \
            ghcr.io/${{ steps.repo.outputs.name }}:proxy-arm64
          docker manifest push ghcr.io/${{ steps.repo.outputs.name }}:proxy

          docker manifest create ghcr.io/${{ steps.repo.outputs.name }}:proxy-sha-${{ github.sha }} \
            ghcr.io/${{ steps.repo.outputs.name }}:proxy-amd64 \
            ghcr.io/${{ steps.repo.outputs.name }}:proxy-arm64
          docker manifest push ghcr.io/${{ steps.repo.outputs.name }}:proxy-sha-${{ github.sha }}

  build-base:
    name: Build Base Image
    needs: [test-cli-integration, test-shell-functions, test-airlock]
    runs-on: ubuntu-24.04
    if: github.ref == 'refs/heads/main'
    outputs:
      push_needed: ${{ steps.push_decision.outputs.push_needed }}
      repo_name: ${{ steps.repo.outputs.name }}
      copilot_version: ${{ steps.versions.outputs.copilot_version }}
      playwright_version: ${{ steps.versions.outputs.playwright_version }}
      dotnet_8_version: ${{ steps.versions.outputs.dotnet_8_version }}
      dotnet_9_version: ${{ steps.versions.outputs.dotnet_9_version }}
      dotnet_10_version: ${{ steps.versions.outputs.dotnet_10_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set lowercase repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to the Container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest dependency versions
        id: versions
        run: |
          COPILOT_VERSION=$(npm view @github/copilot version)
          echo "copilot_version=$COPILOT_VERSION" >> $GITHUB_OUTPUT

          PLAYWRIGHT_VERSION=$(npm view playwright version)
          echo "playwright_version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

          DOTNET_8_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/8.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_8_version=$DOTNET_8_VERSION" >> $GITHUB_OUTPUT

          DOTNET_9_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/9.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_9_version=$DOTNET_9_VERSION" >> $GITHUB_OUTPUT

          DOTNET_10_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/10.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_10_version=$DOTNET_10_VERSION" >> $GITHUB_OUTPUT

      - name: Get digest of the remote 'latest' image
        if: github.event_name != 'push'
        id: remote_digest
        run: |
          DIGEST=$(docker manifest inspect ghcr.io/${{ steps.repo.outputs.name }}:latest 2>/dev/null | jq -r '.config.digest' || echo "")
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Build image and get its new digest
        id: build
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          file: ./docker/tools/github-copilot/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: false
          load: false
          tags: ghcr.io/${{ steps.repo.outputs.name }}:latest
          build-args: |
            COPILOT_VERSION=${{ steps.versions.outputs.copilot_version }}
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:latest,mode=max
          cache-to: type=inline
          outputs: type=image,push=false

      - name: Determine if a push is required
        id: push_decision
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "push_needed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.build.outputs.digest }}" != "${{ steps.remote_digest.outputs.digest }}" ]]; then
            echo "push_needed=true" >> $GITHUB_OUTPUT
          else
            echo "push_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Push base image to registry
        if: steps.push_decision.outputs.push_needed == 'true'
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          file: ./docker/tools/github-copilot/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.name }}:latest
            ghcr.io/${{ steps.repo.outputs.name }}:copilot-latest
            ghcr.io/${{ steps.repo.outputs.name }}:copilot-sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: |
            COPILOT_VERSION=${{ steps.versions.outputs.copilot_version }}
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:latest,mode=max
          cache-to: type=inline

  # Build variants that depend only on the base image
  build-variants:
    name: Build ${{ matrix.variant }}
    needs: [build-base]
    if: needs.build-base.outputs.push_needed == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: rust
            dockerfile: ./docker/variants/Dockerfile.rust
            build_args: "BASE_IMAGE_TAG=copilot-sha-${{ github.sha }}"
          - variant: playwright
            dockerfile: ./docker/variants/Dockerfile.playwright
            build_args: "BASE_IMAGE_TAG=copilot-sha-${{ github.sha }}\nPLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION"
          - variant: dotnet-8
            dockerfile: ./docker/variants/Dockerfile.dotnet8
            build_args: "BASE_IMAGE_TAG=copilot-sha-${{ github.sha }}\nDOTNET_SDK_8_VERSION=$DOTNET_8_VERSION"
          - variant: dotnet-9
            dockerfile: ./docker/variants/Dockerfile.dotnet9
            build_args: "BASE_IMAGE_TAG=copilot-sha-${{ github.sha }}\nDOTNET_SDK_9_VERSION=$DOTNET_9_VERSION"
          - variant: dotnet-10
            dockerfile: ./docker/variants/Dockerfile.dotnet10
            build_args: "BASE_IMAGE_TAG=copilot-sha-${{ github.sha }}\nDOTNET_SDK_10_VERSION=$DOTNET_10_VERSION"
          - variant: dotnet
            dockerfile: ./docker/variants/Dockerfile.dotnet
            build_args: "BASE_IMAGE_TAG=copilot-sha-${{ github.sha }}\nDOTNET_SDK_8_VERSION=$DOTNET_8_VERSION\nDOTNET_SDK_9_VERSION=$DOTNET_9_VERSION\nDOTNET_SDK_10_VERSION=$DOTNET_10_VERSION"
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to the Container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare build args
        id: args
        run: |
          # Replace placeholder variables with actual values
          ARGS="${{ matrix.build_args }}"
          ARGS="${ARGS//\$PLAYWRIGHT_VERSION/${{ needs.build-base.outputs.playwright_version }}}"
          ARGS="${ARGS//\$DOTNET_8_VERSION/${{ needs.build-base.outputs.dotnet_8_version }}}"
          ARGS="${ARGS//\$DOTNET_9_VERSION/${{ needs.build-base.outputs.dotnet_9_version }}}"
          ARGS="${ARGS//\$DOTNET_10_VERSION/${{ needs.build-base.outputs.dotnet_10_version }}}"
          echo "build_args<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.variant }} image
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:copilot-${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:copilot-${{ matrix.variant }}-sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: ${{ steps.args.outputs.build_args }}
          cache-from: type=registry,ref=ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }},mode=max
          cache-to: type=inline

  # Build compound variants that depend on the dotnet image
  build-compound-variants:
    name: Build ${{ matrix.variant }}
    needs: [build-base, build-variants]
    if: needs.build-base.outputs.push_needed == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: dotnet-playwright
            dockerfile: ./docker/compound-variants/Dockerfile.dotnet-playwright
            build_args: "DOTNET_IMAGE_TAG=copilot-dotnet-sha-${{ github.sha }}\nPLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION"
          - variant: dotnet-rust
            dockerfile: ./docker/compound-variants/Dockerfile.dotnet-rust
            build_args: "DOTNET_IMAGE_TAG=copilot-dotnet-sha-${{ github.sha }}"
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to the Container registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare build args
        id: args
        run: |
          ARGS="${{ matrix.build_args }}"
          ARGS="${ARGS//\$PLAYWRIGHT_VERSION/${{ needs.build-base.outputs.playwright_version }}}"
          echo "build_args<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.variant }} image
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:copilot-${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:copilot-${{ matrix.variant }}-sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: ${{ steps.args.outputs.build_args }}
          cache-from: type=registry,ref=ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }},mode=max
          cache-to: type=inline

  # Summary job
  publish-summary:
    name: Publish Summary
    needs:
      [
        build-base,
        build-proxy,
        build-variants,
        build-compound-variants,
        release-cli,
      ]
    if: always() && (needs.build-base.result != 'skipped' || needs.release-cli.result != 'skipped')
    runs-on: ubuntu-24.04
    steps:
      - name: Print summary for scheduled run
        if: github.event_name == 'schedule' && needs.build-base.outputs.push_needed == 'false'
        run: echo "☑️ No new version of the npm package found. The published image is already up-to-date."

      - name: Workflow Summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tests:** ✅ Passed (required before build)" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-base.outputs.push_needed }}" == "true" ]]; then
            echo "**Images Published:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:latest\` (legacy)" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:copilot-latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:proxy\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Variants (with copilot- prefix):**" >> $GITHUB_STEP_SUMMARY
            echo "- \`rust\`, \`copilot-rust\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`playwright\`, \`copilot-playwright\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`dotnet\`, \`copilot-dotnet\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`dotnet-8\`, \`copilot-dotnet-8\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`dotnet-9\`, \`copilot-dotnet-9\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`dotnet-10\`, \`copilot-dotnet-10\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`dotnet-playwright\`, \`copilot-dotnet-playwright\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`dotnet-rust\`, \`copilot-dotnet-rust\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Images:** No changes, skipped publishing" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.release-cli.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**CLI Binaries Published:**" >> $GITHUB_STEP_SUMMARY
            echo "- linux-x64, linux-arm64" >> $GITHUB_STEP_SUMMARY
            echo "- osx-x64, osx-arm64" >> $GITHUB_STEP_SUMMARY
            echo "- win-x64, win-arm64" >> $GITHUB_STEP_SUMMARY
          fi

  # Build native CLI binaries for all platforms
  build-cli:
    name: Build CLI ${{ matrix.rid }}
    needs: [test-cli-integration, test-shell-functions, test-airlock]
    runs-on: ${{ matrix.os }}
    if: github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            rid: linux-x64
            binary: copilot_here
          - os: ubuntu-24.04-arm
            rid: linux-arm64
            binary: copilot_here
          - os: macos-15-intel
            rid: osx-x64
            binary: copilot_here
          - os: macos-latest
            rid: osx-arm64
            binary: copilot_here
          - os: windows-latest
            rid: win-x64
            binary: copilot_here.exe
          - os: windows-11-arm
            rid: win-arm64
            binary: copilot_here.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4
        with:
          global-json-file: global.json

      - name: Extract version from shell script
        id: version
        shell: bash
        run: |
          VERSION=$(grep -m1 "^# Version:" copilot_here.sh | sed 's/# Version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Update BuildInfo with version
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i.bak "s/BuildDate = \".*\"/BuildDate = \"$VERSION\"/" app/Infrastructure/BuildInfo.cs
          cat app/Infrastructure/BuildInfo.cs

      - name: Publish AOT binary
        run: dotnet publish app/CopilotHere.csproj -c Release -r ${{ matrix.rid }} -o publish/${{ matrix.rid }}

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: copilot_here-${{ matrix.rid }}
          path: publish/${{ matrix.rid }}/${{ matrix.binary }}
          if-no-files-found: error

  # Create release with CLI binaries
  release-cli:
    name: Release CLI
    needs: [build-cli]
    runs-on: ubuntu-24.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Download all artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          for rid in linux-x64 linux-arm64 osx-x64 osx-arm64 win-x64 win-arm64; do
            if [[ "$rid" == win-* ]]; then
              binary="copilot_here.exe"
            else
              binary="copilot_here"
            fi
            
            # Create archive
            cd artifacts/copilot_here-$rid
            if [[ "$rid" == win-* ]]; then
              zip ../../release/copilot_here-$rid.zip $binary
            else
              chmod +x $binary
              tar -czvf ../../release/copilot_here-$rid.tar.gz $binary
            fi
            cd ../..
          done

          # Include shell scripts and install scripts in release
          cp copilot_here.sh release/
          cp copilot_here.ps1 release/
          cp install.sh release/
          cp install.ps1 release/

          ls -la release/

      - name: Get version from shell script
        id: version
        run: |
          VERSION=$(grep -m1 "^# Version:" copilot_here.sh | sed 's/# Version: //')
          if [ -z "$VERSION" ]; then
            VERSION="0.1.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Create versioned release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}
          name: CLI v${{ steps.version.outputs.version }} (${{ steps.version.outputs.short_sha }})
          body: |
            ## Native AOT CLI Binary

            Commit: ${{ github.sha }}

            ### Download

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x64 | [copilot_here-linux-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot_here-linux-x64.tar.gz) |
            | Linux | ARM64 | [copilot_here-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot_here-linux-arm64.tar.gz) |
            | macOS | x64 | [copilot_here-osx-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot_here-osx-x64.tar.gz) |
            | macOS | ARM64 | [copilot_here-osx-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot_here-osx-arm64.tar.gz) |
            | Windows | x64 | [copilot_here-win-x64.zip](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot_here-win-x64.zip) |
            | Windows | ARM64 | [copilot_here-win-arm64.zip](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot_here-win-arm64.zip) |

            ### Installation

            See [README](https://github.com/${{ github.repository }}#installation) for installation instructions.
          files: release/*
          draft: false
          prerelease: false
          make_latest: false

      - name: Delete existing cli-latest tag
        run: |
          gh release delete cli-latest --yes || true
          git push origin :refs/tags/cli-latest || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create latest release (for easy download)
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: cli-latest
          name: CLI v${{ steps.version.outputs.version }}
          body: |
            ## Latest Native AOT CLI Binary

            **Version:** ${{ steps.version.outputs.version }}
            **Commit:** ${{ github.sha }}

            This release is automatically updated with the latest CLI build.
            For versioned releases, see the [releases page](https://github.com/${{ github.repository }}/releases).

            ### Installation

            See [README](https://github.com/${{ github.repository }}#installation) for installation instructions.
          files: release/*
          draft: false
          prerelease: false
          make_latest: true
