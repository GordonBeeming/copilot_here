# This workflow builds and publishes the Docker image.
# Tests run first on all triggers. Publishing only happens on main branch.
name: Build and Publish Docker Images

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    # Runs nightly at 3:15 AM UTC to check for package updates.
    - cron: "15 3 * * *"
  workflow_dispatch: # Allows the workflow to be run manually from the Actions tab

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

# Sets the minimum required permissions for the entire workflow for security.
permissions:
  contents: read
  packages: write

jobs:
  # Run tests first - required for all triggers
  test-bash-zsh:
    name: Test Bash/Zsh on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PowerShell (for cross-platform testing)
        shell: bash
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            # Install PowerShell on Ubuntu
            sudo apt-get update
            sudo apt-get install -y wget apt-transport-https software-properties-common
            wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
            sudo dpkg -i packages-microsoft-prod.deb
            sudo apt-get update
            sudo apt-get install -y powershell
          elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            # Install PowerShell on macOS
            brew install --cask powershell
          fi

      - name: Make test scripts executable
        run: chmod +x tests/run_all_tests.sh tests/integration/*.sh

      - name: Run all integration tests
        run: ./tests/run_all_tests.sh

  test-windows:
    name: Test PowerShell on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PowerShell integration tests
        shell: pwsh
        run: |
          pwsh tests/run_all_tests.ps1

  # Note: Only runs on ubuntu-latest as Docker images are Linux-based
  # (macOS runners don't have Docker, Windows Docker can't run Linux containers)
  test-airlock:
    name: Test Airlock
    needs: [test-bash-zsh, test-windows]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build images locally
        run: |
          chmod +x ./dev-build.sh
          ./dev-build.sh

      - name: Make test script executable
        run: chmod +x tests/integration/test_airlock.sh

      - name: Run airlock integration tests
        run: ./tests/integration/test_airlock.sh --use-local

  build-base:
    name: Build Base Image
    needs: [test-airlock]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    outputs:
      push_needed: ${{ steps.push_decision.outputs.push_needed }}
      repo_name: ${{ steps.repo.outputs.name }}
      copilot_version: ${{ steps.versions.outputs.copilot_version }}
      playwright_version: ${{ steps.versions.outputs.playwright_version }}
      dotnet_8_version: ${{ steps.versions.outputs.dotnet_8_version }}
      dotnet_9_version: ${{ steps.versions.outputs.dotnet_9_version }}
      dotnet_10_version: ${{ steps.versions.outputs.dotnet_10_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set lowercase repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest dependency versions
        id: versions
        run: |
          COPILOT_VERSION=$(npm view @github/copilot version)
          echo "copilot_version=$COPILOT_VERSION" >> $GITHUB_OUTPUT

          PLAYWRIGHT_VERSION=$(npm view playwright version)
          echo "playwright_version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

          DOTNET_8_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/8.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_8_version=$DOTNET_8_VERSION" >> $GITHUB_OUTPUT

          DOTNET_9_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/9.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_9_version=$DOTNET_9_VERSION" >> $GITHUB_OUTPUT

          DOTNET_10_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/10.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_10_version=$DOTNET_10_VERSION" >> $GITHUB_OUTPUT

      - name: Get digest of the remote 'latest' image
        if: github.event_name != 'push'
        id: remote_digest
        run: |
          DIGEST=$(docker manifest inspect ghcr.io/${{ steps.repo.outputs.name }}:latest 2>/dev/null | jq -r '.config.digest' || echo "")
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Build image and get its new digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.base
          platforms: linux/amd64,linux/arm64
          push: false
          load: false
          tags: ghcr.io/${{ steps.repo.outputs.name }}:latest
          build-args: |
            COPILOT_VERSION=${{ steps.versions.outputs.copilot_version }}
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:latest,mode=max
          cache-to: type=inline
          outputs: type=image,push=false

      - name: Determine if a push is required
        id: push_decision
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "push_needed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.build.outputs.digest }}" != "${{ steps.remote_digest.outputs.digest }}" ]]; then
            echo "push_needed=true" >> $GITHUB_OUTPUT
          else
            echo "push_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Push base image to registry
        if: steps.push_decision.outputs.push_needed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.base
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.name }}:latest
            ghcr.io/${{ steps.repo.outputs.name }}:sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: |
            COPILOT_VERSION=${{ steps.versions.outputs.copilot_version }}
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:latest,mode=max
          cache-to: type=inline

  # Build variants that depend only on the base image
  build-variants:
    name: Build ${{ matrix.variant }}
    needs: [build-base]
    if: needs.build-base.outputs.push_needed == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: proxy
            dockerfile: ./docker/Dockerfile.proxy
            build_args: ""
          - variant: rust
            dockerfile: ./docker/variants/Dockerfile.rust
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}"
          - variant: playwright
            dockerfile: ./docker/variants/Dockerfile.playwright
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nPLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION"
          - variant: dotnet-8
            dockerfile: ./docker/variants/Dockerfile.dotnet8
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_8_VERSION=$DOTNET_8_VERSION"
          - variant: dotnet-9
            dockerfile: ./docker/variants/Dockerfile.dotnet9
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_9_VERSION=$DOTNET_9_VERSION"
          - variant: dotnet-10
            dockerfile: ./docker/variants/Dockerfile.dotnet10
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_10_VERSION=$DOTNET_10_VERSION"
          - variant: dotnet
            dockerfile: ./docker/variants/Dockerfile.dotnet
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_8_VERSION=$DOTNET_8_VERSION\nDOTNET_SDK_9_VERSION=$DOTNET_9_VERSION\nDOTNET_SDK_10_VERSION=$DOTNET_10_VERSION"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare build args
        id: args
        run: |
          # Replace placeholder variables with actual values
          ARGS="${{ matrix.build_args }}"
          ARGS="${ARGS//\$PLAYWRIGHT_VERSION/${{ needs.build-base.outputs.playwright_version }}}"
          ARGS="${ARGS//\$DOTNET_8_VERSION/${{ needs.build-base.outputs.dotnet_8_version }}}"
          ARGS="${ARGS//\$DOTNET_9_VERSION/${{ needs.build-base.outputs.dotnet_9_version }}}"
          ARGS="${ARGS//\$DOTNET_10_VERSION/${{ needs.build-base.outputs.dotnet_10_version }}}"
          echo "build_args<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.variant }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}-sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: ${{ steps.args.outputs.build_args }}
          cache-from: type=registry,ref=ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }},mode=max
          cache-to: type=inline

  # Build compound variants that depend on the dotnet image
  build-compound-variants:
    name: Build ${{ matrix.variant }}
    needs: [build-base, build-variants]
    if: needs.build-base.outputs.push_needed == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: dotnet-playwright
            dockerfile: ./docker/compound-variants/Dockerfile.dotnet-playwright
            build_args: "DOTNET_IMAGE_TAG=dotnet-sha-${{ github.sha }}\nPLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION"
          - variant: dotnet-rust
            dockerfile: ./docker/compound-variants/Dockerfile.dotnet-rust
            build_args: "DOTNET_IMAGE_TAG=dotnet-sha-${{ github.sha }}"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare build args
        id: args
        run: |
          ARGS="${{ matrix.build_args }}"
          ARGS="${ARGS//\$PLAYWRIGHT_VERSION/${{ needs.build-base.outputs.playwright_version }}}"
          echo "build_args<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.variant }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}-sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: ${{ steps.args.outputs.build_args }}
          cache-from: type=registry,ref=ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }},mode=max
          cache-to: type=inline

  # Summary job
  publish-summary:
    name: Publish Summary
    needs: [build-base, build-variants, build-compound-variants]
    if: always() && needs.build-base.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Print summary for scheduled run
        if: github.event_name == 'schedule' && needs.build-base.outputs.push_needed == 'false'
        run: echo "☑️ No new version of the npm package found. The published image is already up-to-date."

      - name: Workflow Summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tests:** ✅ Passed (required before build)" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-base.outputs.push_needed }}" == "true" ]]; then
            echo "**Images Published:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:proxy\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:rust\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:playwright\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-8\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-9\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-10\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-playwright\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-rust\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Images:** No changes, skipped publishing" >> $GITHUB_STEP_SUMMARY
          fi
