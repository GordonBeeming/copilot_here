# This workflow builds and publishes Docker images and native CLI binaries.
# Tests run first on all triggers. Publishing only happens on main branch.
name: Build and Publish

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    # Runs nightly at 3:15 AM UTC to check for package updates.
    - cron: "15 3 * * *"
  workflow_dispatch: # Allows the workflow to be run manually from the Actions tab

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

# Sets the minimum required permissions for the entire workflow for security.
permissions:
  contents: write
  packages: write

jobs:
  # Run CLI tests on all platforms
  test-cli:
    name: Test CLI (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore

      - name: Test
        run: dotnet test --no-build --verbosity normal

  # Note: Only runs on ubuntu-latest as Docker images are Linux-based
  # (macOS runners don't have Docker, Windows Docker can't run Linux containers)
  test-airlock:
    name: Test Airlock
    needs: [test-cli]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build images locally
        run: |
          chmod +x ./dev-build.sh
          ./dev-build.sh

      - name: Make test script executable
        run: chmod +x tests/integration/test_airlock.sh

      - name: Run airlock integration tests
        run: ./tests/integration/test_airlock.sh --use-local

  build-base:
    name: Build Base Image
    needs: [test-airlock]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    outputs:
      push_needed: ${{ steps.push_decision.outputs.push_needed }}
      repo_name: ${{ steps.repo.outputs.name }}
      copilot_version: ${{ steps.versions.outputs.copilot_version }}
      playwright_version: ${{ steps.versions.outputs.playwright_version }}
      dotnet_8_version: ${{ steps.versions.outputs.dotnet_8_version }}
      dotnet_9_version: ${{ steps.versions.outputs.dotnet_9_version }}
      dotnet_10_version: ${{ steps.versions.outputs.dotnet_10_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set lowercase repository name
        id: repo
        run: echo "name=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest dependency versions
        id: versions
        run: |
          COPILOT_VERSION=$(npm view @github/copilot version)
          echo "copilot_version=$COPILOT_VERSION" >> $GITHUB_OUTPUT

          PLAYWRIGHT_VERSION=$(npm view playwright version)
          echo "playwright_version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

          DOTNET_8_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/8.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_8_version=$DOTNET_8_VERSION" >> $GITHUB_OUTPUT

          DOTNET_9_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/9.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_9_version=$DOTNET_9_VERSION" >> $GITHUB_OUTPUT

          DOTNET_10_VERSION=$(curl -s https://dotnetcli.blob.core.windows.net/dotnet/release-metadata/10.0/releases.json | jq -r '."latest-sdk"')
          echo "dotnet_10_version=$DOTNET_10_VERSION" >> $GITHUB_OUTPUT

      - name: Get digest of the remote 'latest' image
        if: github.event_name != 'push'
        id: remote_digest
        run: |
          DIGEST=$(docker manifest inspect ghcr.io/${{ steps.repo.outputs.name }}:latest 2>/dev/null | jq -r '.config.digest' || echo "")
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Build image and get its new digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.base
          platforms: linux/amd64,linux/arm64
          push: false
          load: false
          tags: ghcr.io/${{ steps.repo.outputs.name }}:latest
          build-args: |
            COPILOT_VERSION=${{ steps.versions.outputs.copilot_version }}
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:latest,mode=max
          cache-to: type=inline
          outputs: type=image,push=false

      - name: Determine if a push is required
        id: push_decision
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "push_needed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.build.outputs.digest }}" != "${{ steps.remote_digest.outputs.digest }}" ]]; then
            echo "push_needed=true" >> $GITHUB_OUTPUT
          else
            echo "push_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Push base image to registry
        if: steps.push_decision.outputs.push_needed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.base
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ steps.repo.outputs.name }}:latest
            ghcr.io/${{ steps.repo.outputs.name }}:sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: |
            COPILOT_VERSION=${{ steps.versions.outputs.copilot_version }}
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.name }}:latest,mode=max
          cache-to: type=inline

  # Build variants that depend only on the base image
  build-variants:
    name: Build ${{ matrix.variant }}
    needs: [build-base]
    if: needs.build-base.outputs.push_needed == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: proxy
            dockerfile: ./docker/Dockerfile.proxy
            build_args: ""
          - variant: rust
            dockerfile: ./docker/variants/Dockerfile.rust
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}"
          - variant: playwright
            dockerfile: ./docker/variants/Dockerfile.playwright
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nPLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION"
          - variant: dotnet-8
            dockerfile: ./docker/variants/Dockerfile.dotnet8
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_8_VERSION=$DOTNET_8_VERSION"
          - variant: dotnet-9
            dockerfile: ./docker/variants/Dockerfile.dotnet9
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_9_VERSION=$DOTNET_9_VERSION"
          - variant: dotnet-10
            dockerfile: ./docker/variants/Dockerfile.dotnet10
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_10_VERSION=$DOTNET_10_VERSION"
          - variant: dotnet
            dockerfile: ./docker/variants/Dockerfile.dotnet
            build_args: "BASE_IMAGE_TAG=sha-${{ github.sha }}\nDOTNET_SDK_8_VERSION=$DOTNET_8_VERSION\nDOTNET_SDK_9_VERSION=$DOTNET_9_VERSION\nDOTNET_SDK_10_VERSION=$DOTNET_10_VERSION"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare build args
        id: args
        run: |
          # Replace placeholder variables with actual values
          ARGS="${{ matrix.build_args }}"
          ARGS="${ARGS//\$PLAYWRIGHT_VERSION/${{ needs.build-base.outputs.playwright_version }}}"
          ARGS="${ARGS//\$DOTNET_8_VERSION/${{ needs.build-base.outputs.dotnet_8_version }}}"
          ARGS="${ARGS//\$DOTNET_9_VERSION/${{ needs.build-base.outputs.dotnet_9_version }}}"
          ARGS="${ARGS//\$DOTNET_10_VERSION/${{ needs.build-base.outputs.dotnet_10_version }}}"
          echo "build_args<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.variant }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}-sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: ${{ steps.args.outputs.build_args }}
          cache-from: type=registry,ref=ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }},mode=max
          cache-to: type=inline

  # Build compound variants that depend on the dotnet image
  build-compound-variants:
    name: Build ${{ matrix.variant }}
    needs: [build-base, build-variants]
    if: needs.build-base.outputs.push_needed == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: dotnet-playwright
            dockerfile: ./docker/compound-variants/Dockerfile.dotnet-playwright
            build_args: "DOTNET_IMAGE_TAG=dotnet-sha-${{ github.sha }}\nPLAYWRIGHT_VERSION=$PLAYWRIGHT_VERSION"
          - variant: dotnet-rust
            dockerfile: ./docker/compound-variants/Dockerfile.dotnet-rust
            build_args: "DOTNET_IMAGE_TAG=dotnet-sha-${{ github.sha }}"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare build args
        id: args
        run: |
          ARGS="${{ matrix.build_args }}"
          ARGS="${ARGS//\$PLAYWRIGHT_VERSION/${{ needs.build-base.outputs.playwright_version }}}"
          echo "build_args<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ARGS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build and push ${{ matrix.variant }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}
            ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }}-sha-${{ github.sha }}
          labels: project=copilot_here
          build-args: ${{ steps.args.outputs.build_args }}
          cache-from: type=registry,ref=ghcr.io/${{ needs.build-base.outputs.repo_name }}:${{ matrix.variant }},mode=max
          cache-to: type=inline

  # Summary job
  publish-summary:
    name: Publish Summary
    needs: [build-base, build-variants, build-compound-variants, release-cli]
    if: always() && (needs.build-base.result != 'skipped' || needs.release-cli.result != 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Print summary for scheduled run
        if: github.event_name == 'schedule' && needs.build-base.outputs.push_needed == 'false'
        run: echo "☑️ No new version of the npm package found. The published image is already up-to-date."

      - name: Workflow Summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tests:** ✅ Passed (required before build)" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.build-base.outputs.push_needed }}" == "true" ]]; then
            echo "**Images Published:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:proxy\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:rust\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:playwright\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-8\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-9\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-10\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-playwright\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ needs.build-base.outputs.repo_name }}:dotnet-rust\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Images:** No changes, skipped publishing" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.release-cli.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**CLI Binaries Published:**" >> $GITHUB_STEP_SUMMARY
            echo "- linux-x64, linux-arm64" >> $GITHUB_STEP_SUMMARY
            echo "- osx-x64, osx-arm64" >> $GITHUB_STEP_SUMMARY
            echo "- win-x64, win-arm64" >> $GITHUB_STEP_SUMMARY
          fi

  # Build native CLI binaries for all platforms
  build-cli:
    name: Build CLI ${{ matrix.rid }}
    needs: [test-airlock]
    runs-on: ${{ matrix.os }}
    if: github.event_name != 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            binary: copilot-here
          - os: ubuntu-24.04-arm
            rid: linux-arm64
            binary: copilot-here
          - os: macos-13
            rid: osx-x64
            binary: copilot-here
          - os: macos-latest
            rid: osx-arm64
            binary: copilot-here
          - os: windows-latest
            rid: win-x64
            binary: copilot-here.exe
          - os: windows-11-arm
            rid: win-arm64
            binary: copilot-here.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Publish AOT binary
        run: dotnet publish app/CopilotHere.csproj -c Release -r ${{ matrix.rid }} -o publish/${{ matrix.rid }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: copilot-here-${{ matrix.rid }}
          path: publish/${{ matrix.rid }}/${{ matrix.binary }}
          if-no-files-found: error

  # Create release with CLI binaries
  release-cli:
    name: Release CLI
    needs: [build-cli]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          for rid in linux-x64 linux-arm64 osx-x64 osx-arm64 win-x64 win-arm64; do
            if [[ "$rid" == win-* ]]; then
              binary="copilot-here.exe"
            else
              binary="copilot-here"
            fi
            
            # Create archive
            cd artifacts/copilot-here-$rid
            if [[ "$rid" == win-* ]]; then
              zip ../../release/copilot-here-$rid.zip $binary
            else
              chmod +x $binary
              tar -czvf ../../release/copilot-here-$rid.tar.gz $binary
            fi
            cd ../..
          done
          
          ls -la release/

      - name: Get version from project
        id: version
        run: |
          VERSION=$(grep -oP '<Version>\K[^<]+' app/CopilotHere.csproj 2>/dev/null || echo "0.1.0")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          SHORT_SHA="${GITHUB_SHA:0:7}"
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Create versioned release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}
          name: CLI v${{ steps.version.outputs.version }} (${{ steps.version.outputs.short_sha }})
          body: |
            ## Native AOT CLI Binary
            
            Commit: ${{ github.sha }}
            
            ### Download
            
            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x64 | [copilot-here-linux-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot-here-linux-x64.tar.gz) |
            | Linux | ARM64 | [copilot-here-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot-here-linux-arm64.tar.gz) |
            | macOS | x64 | [copilot-here-osx-x64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot-here-osx-x64.tar.gz) |
            | macOS | ARM64 | [copilot-here-osx-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot-here-osx-arm64.tar.gz) |
            | Windows | x64 | [copilot-here-win-x64.zip](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot-here-win-x64.zip) |
            | Windows | ARM64 | [copilot-here-win-arm64.zip](https://github.com/${{ github.repository }}/releases/download/cli-v${{ steps.version.outputs.version }}-${{ steps.version.outputs.short_sha }}/copilot-here-win-arm64.zip) |
            
            ### Installation
            
            See [README](https://github.com/${{ github.repository }}#installation) for installation instructions.
          files: release/*
          draft: false
          prerelease: false
          make_latest: false

      - name: Delete existing cli-latest tag
        run: |
          gh release delete cli-latest --yes || true
          git push origin :refs/tags/cli-latest || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create latest release (for easy download)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: cli-latest
          name: CLI Latest
          body: |
            ## Latest Native AOT CLI Binary
            
            **Version:** ${{ steps.version.outputs.version }}
            **Commit:** ${{ github.sha }}
            
            This release is automatically updated with the latest CLI build.
            For versioned releases, see the [releases page](https://github.com/${{ github.repository }}/releases).
            
            ### Installation
            
            See [README](https://github.com/${{ github.repository }}#installation) for installation instructions.
          files: release/*
          draft: false
          prerelease: false
          make_latest: true
