# Build on top of the .NET image to add Playwright capabilities
# ARG will be provided by the build process with the commit hash
ARG DOTNET_IMAGE_TAG
ARG PLAYWRIGHT_VERSION=latest
FROM ghcr.io/gordonbeeming/copilot_here:${DOTNET_IMAGE_TAG}

# Switch to root to install packages
USER root

# Install Playwright dependencies and Chromium
# Using Playwright's system dependencies approach
RUN apt-get update && apt-get install -y \
  # Playwright system dependencies for Chromium
  libnss3 \
  libnspr4 \
  libatk1.0-0 \
  libatk-bridge2.0-0 \
  libcups2 \
  libdrm2 \
  libdbus-1-3 \
  libxkbcommon0 \
  libxcomposite1 \
  libxdamage1 \
  libxfixes3 \
  libxrandr2 \
  libgbm1 \
  libpango-1.0-0 \
  libcairo2 \
  libasound2 \
  libatspi2.0-0 \
  libxshmfence1 \
  && rm -rf /var/lib/apt/lists/*

# Install Playwright globally via npm
RUN npm install -g playwright@${PLAYWRIGHT_VERSION}

# Create the directory structure for playwright cache
# We'll install as root but place files where appuser can access them
RUN mkdir -p /home/appuser/.cache/ms-playwright

# Install Chromium browser for Playwright as root
# Place it in a location that will be accessible to appuser at runtime
RUN PLAYWRIGHT_BROWSERS_PATH=/home/appuser/.cache/ms-playwright npx playwright install chromium --with-deps

# Fix ownership for the appuser (UID/GID from entrypoint will match)
RUN chown -R 1000:1000 /home/appuser 2>/dev/null || true

# The entrypoint and CMD remain the same as the base image
# They are inherited automatically
