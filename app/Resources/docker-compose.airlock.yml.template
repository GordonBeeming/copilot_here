# Airlock - Docker Compose Configuration
# Generated by copilot_here for secure network proxy mode
#
# The app container is on an airlock and can ONLY reach the proxy.
# The proxy bridges to the internet - no direct internet access from app.
#
# Environment variables read from shell (NOT written to file for security):
#   GITHUB_TOKEN           - GitHub token for authentication

networks:
  airlock:
    # Airlock network - no default route to internet
    internal: true
  bridge:
    # Standard bridge network with internet access

volumes:
  proxy-ca:
    # Shared CA certificate between proxy and app

services:
  proxy:
    image: {{PROXY_IMAGE}}
    container_name: "{{PROJECT_NAME}}-proxy"
    networks:
      - airlock  # Receives requests from app container
      - bridge    # Makes outbound requests to internet
    volumes:
      - {{NETWORK_CONFIG}}:/config/rules.json:ro
      - proxy-ca:/ca
{{LOGS_MOUNT}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:58080/health"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  app:
    image: {{APP_IMAGE}}
    container_name: "{{PROJECT_NAME}}-app"
    networks:
      - airlock  # ONLY on airlock - cannot reach internet directly
    environment:
      - HTTP_PROXY=http://proxy:58080
      - HTTPS_PROXY=http://proxy:58080
      - http_proxy=http://proxy:58080
      - https_proxy=http://proxy:58080
      - PUID={{PUID}}
      - PGID={{PGID}}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - TERM=${TERM:-xterm-256color}
    volumes:
      - proxy-ca:/ca:ro
      - {{COPILOT_CONFIG}}:/home/appuser/.copilot
      - {{WORK_DIR}}:{{CONTAINER_WORK_DIR}}
{{EXTRA_MOUNTS}}
    working_dir: {{CONTAINER_WORK_DIR}}
    entrypoint: ["/usr/local/bin/entrypoint-airlock.sh"]
    command: {{COPILOT_ARGS}}
    depends_on:
      proxy:
        condition: service_healthy
    stdin_open: true
    tty: true
