# Build on top of the base copilot_here image
# ARG will be provided by the build process with the commit hash
ARG BASE_IMAGE_TAG
FROM ghcr.io/gordonbeeming/copilot_here:${BASE_IMAGE_TAG}

ARG DOTNET_SDK_8_VERSION
ARG DOTNET_SDK_9_VERSION
ARG DOTNET_SDK_10_VERSION

# Switch to root to install packages
USER root

# Install .NET SDK prerequisites and ICU libraries
RUN apt-get update && apt-get install -y \
  wget \
  ca-certificates \
  libicu-dev \
  && rm -rf /var/lib/apt/lists/*

# Install .NET 8 SDK (latest)
RUN wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh \
  && chmod +x dotnet-install.sh \
  && if [ -z "$DOTNET_SDK_8_VERSION" ]; then \
       ./dotnet-install.sh --channel 8.0 --install-dir /usr/share/dotnet; \
     else \
       ./dotnet-install.sh --version $DOTNET_SDK_8_VERSION --install-dir /usr/share/dotnet; \
     fi \
  && rm dotnet-install.sh

# Install .NET 9 SDK (latest)
RUN wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh \
  && chmod +x dotnet-install.sh \
  && if [ -z "$DOTNET_SDK_9_VERSION" ]; then \
       ./dotnet-install.sh --channel 9.0 --install-dir /usr/share/dotnet; \
     else \
       ./dotnet-install.sh --version $DOTNET_SDK_9_VERSION --install-dir /usr/share/dotnet; \
     fi \
  && rm dotnet-install.sh

# Install .NET 10 SDK (latest)
RUN wget https://dot.net/v1/dotnet-install.sh -O dotnet-install.sh \
  && chmod +x dotnet-install.sh \
  && if [ -z "$DOTNET_SDK_10_VERSION" ]; then \
       ./dotnet-install.sh --channel 10.0 --install-dir /usr/share/dotnet; \
     else \
       ./dotnet-install.sh --version $DOTNET_SDK_10_VERSION --install-dir /usr/share/dotnet; \
     fi \
  && rm dotnet-install.sh

# Add .NET to PATH
ENV PATH="/usr/share/dotnet:${PATH}"
ENV DOTNET_ROOT="/usr/share/dotnet"

# Verify installations
RUN dotnet --list-sdks

# The entrypoint and CMD remain the same as the base image
# They are inherited automatically
